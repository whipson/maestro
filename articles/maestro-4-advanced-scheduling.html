<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced Scheduling • maestro</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Scheduling">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">maestro</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/maestro-1-quick-start.html">Quick Start</a></li>
    <li><a class="dropdown-item" href="../articles/maestro-2-motivation-concepts.html">Motivation and Concepts</a></li>
    <li><a class="dropdown-item" href="../articles/maestro-3-use-cases.html">Use Cases</a></li>
    <li><a class="dropdown-item" href="../articles/maestro-4-advanced-scheduling.html">Advanced Scheduling</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://whipson.github.io/data-in-flight/posts/hello-maestro/hello-maestro.html">Hello maestro</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/whipson/maestro/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Advanced Scheduling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/whipson/maestro/blob/main/vignettes/maestro-4-advanced-scheduling.Rmd" class="external-link"><code>vignettes/maestro-4-advanced-scheduling.Rmd</code></a></small>
      <div class="d-none name"><code>maestro-4-advanced-scheduling.Rmd</code></div>
    </div>

    
    
<p>This vignette covers more advanced concepts and examples related to
scheduling. At it’s core, maestro adheres to two keys principles:</p>
<ol style="list-style-type: decimal">
<li>Stateless: It does not need to be continuously running - it can be
run in a serverless architecture</li>
<li>Use of <em>rounded scheduling</em>: The timeliness of pipeline
executions depends on how often you run your orchestrator</li>
</ol>
<p>Here, we’ll explain these concepts more deeply in the context of
maestro and give some concrete examples.</p>
<div class="section level2">
<h2 id="stateless-execution">Stateless Execution<a class="anchor" aria-label="anchor" href="#stateless-execution"></a>
</h2>
<p>Maestro takes a unique approach to scheduling compared to other
orchestration tools. Whereas most schedulers involve a continuously
running program to monitor the time and execute jobs when the current
time is right, maestro is designed to run intermittently. It also
doesn’t need to save or cache data between executions - in other words,
it’s <em>stateless</em>.</p>
<p>This design has several benefits; namely, you can run it in a
serverless way which saves on compute resources. However, to achieve
this it takes some shortcuts which may mean that precise timeliness is
lost. This will become clearer in our examples.</p>
</div>
<div class="section level2">
<h2 id="rounded-scheduling">Rounded Scheduling<a class="anchor" aria-label="anchor" href="#rounded-scheduling"></a>
</h2>
<p>The timeliness of a pipeline is measured in how close the scheduled
execution time is to the actual execution time. <strong>Maestro is only
as timely as it needs to be relative to the unit of time you are
interested in</strong>. This is the concept of <em>rounded
scheduling</em>. If you run your orchestrator once daily, then the
timeliness of the pipelines will be within the nearest day - it doesn’t
care that you specified a pipeline to run at exactly 09:21:20 each day.
If you run it every 10 minutes, then the timeliness of the pipelines
will be within the nearest 10 minute interval.</p>
<p>Let’s look at some examples:</p>
<p>First, we’ll consider one pipeline that is scheduled to run daily at
09:20:00 and we’ll configure the orchestrator to run daily.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ./pipelines/daily_example.R</span></span>
<span><span class="co">#' daily_example maestro pipeline</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @maestroFrequency 1 day</span></span>
<span><span class="co">#' @maestroStartTime 2024-06-20 09:20:00</span></span>
<span><span class="va">daily_example</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Pipeline code</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For demonstration purposes, I’ll manually set the check time to be
08:00:00 UTC (this is the time maestro will use to compare against the
scheduled time). In practice, you almost always want this to be the
system time using either <code><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time()</a></code> or
<code><a href="https://lubridate.tidyverse.org/reference/now.html" class="external-link">lubridate::now()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ./orchestrator.R</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/whipson/maestro" class="external-link">maestro</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">schedule</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_schedule.html">build_schedule</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> 1 script successfully parsed</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">status</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_schedule.html">run_schedule</a></span><span class="op">(</span></span>
<span>  <span class="va">schedule</span>,</span>
<span>  orch_frequency <span class="op">=</span> <span class="st">"1 day"</span>,</span>
<span>  check_datetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-06-20 08:00:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## ── Running pipelines <span style="color: #00BB00;">▶</span> </span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> <span style="color: #555555;">./pipelines/daily_example.R</span> <span style="color: #0000BB;">daily_example</span></span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #555555;">./pipelines/daily_example.R</span> <span style="color: #0000BB;">daily_example</span> <span style="color: #B2B2B2;">[55ms]</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── Pipeline execution completed <span style="color: #555555;">■</span> | 0.079 sec elapsed </span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> 1 success | <span style="color: #000000;">→</span> 0 skipped | <span style="color: #BB00BB;">!</span> 0 warnings | <span style="color: #BB0000;">✖</span> 0 errors | <span style="color: #00BBBB;">◼</span> 1 total</span></span>
<span><span class="co">## ────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── Next scheduled pipelines <span style="color: #00BBBB;">❯</span> </span></span>
<span><span class="co">## Pipe name | Next scheduled run</span></span>
<span><span class="co">## • daily_example | 2024-06-20</span></span></code></pre>
<p>We can see that the pipeline executed even though the current time
was not 09:20:00. This is because we set the orchestrator to run daily
and so it considers it close enough to within a day.</p>
<p>Let’s see what happens if we up the frequency of the
orchestrator:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ./orchestrator.R</span></span>
<span><span class="va">status</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_schedule.html">run_schedule</a></span><span class="op">(</span></span>
<span>  <span class="va">schedule</span>,</span>
<span>  orch_frequency <span class="op">=</span> <span class="st">"15 minutes"</span>,</span>
<span>  check_datetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2024-06-20 08:00:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── Running pipelines <span style="color: #00BB00;">▶</span></span></span></code></pre>
<pre><code><span><span class="co">## → <span style="color: #555555;">./pipelines/daily_example.R</span> daily_example</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── Pipeline execution completed <span style="color: #555555;">■</span> | 0.004 sec elapsed</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> 0 successes | <span style="color: #000000;">→</span> 1 skipped | <span style="color: #BB00BB;">!</span> 0 warnings | <span style="color: #BB0000;">✖</span> 0 errors | <span style="color: #00BBBB;">◼</span> 1 total</span></span></code></pre>
<pre><code><span><span class="co">## ────────────────────────────────────────────────────────────────────────────────</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── Next scheduled pipelines <span style="color: #00BBBB;">❯</span></span></span></code></pre>
<pre><code><span><span class="co">## Pipe name | Next scheduled run</span></span></code></pre>
<pre><code><span><span class="co">## • daily_example | 2024-06-20 09:15:00</span></span></code></pre>
<p>It was skipped because it wasn’t within a 15 minute degree of
difference but the output tells us that will next run at
<code>2024-06-20 09:15:00</code>.<br><br>
The takeaway message is that the timeliness of the pipeline depends on
how frequently the orchestrator runs. Remember that when you declare the
<code>orch_frequency = "15 minutes"</code> that is essentially a
contract stating that you <em>will</em> run it every 15 minutes -
maestro does not do this for you. If you run the orchestrator more or
less frequently than you said you would unexpected things will happen.
Specifically, if you run it more frequently than stated, your pipelines
will run more often than expected, likewise less frequently than stated
means that pipelines won’t run as often.</p>
</div>
<div class="section level2">
<h2 id="how-often-should-i-schedule-my-orchestrator">
<em>How often should I schedule my orchestrator?</em><a class="anchor" aria-label="anchor" href="#how-often-should-i-schedule-my-orchestrator"></a>
</h2>
<p>If you have a single pipeline or even multiple pipelines that all run
at the same time this is an easy question to answer. In practice (and in
our experience using maestro in production) you have multiple pipelines
that run at different intervals and different times. Maybe some run
hourly, some run daily, and others run monthly.</p>
<div class="section level3">
<h3 id="example-1">Example 1<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h3>
<p>Let’s say we have three pipelines with the following frequencies and
start times:</p>
<pre><code><span><span class="co">##    name frequency          start_time</span></span>
<span><span class="co">## 1 pipe1    1 hour 2024-06-18 12:30:00</span></span>
<span><span class="co">## 2 pipe2    2 days 2024-06-18 06:00:00</span></span>
<span><span class="co">## 3 pipe3  4 months 2024-06-20 00:00:00</span></span></code></pre>
<p>A good starting point is to schedule it as often as the highest
frequency pipeline in the project - so <code>1 hour</code> in the above
example. If you run it on *:30:00 minute each day, pipe1 will execute
nearly exactly at the scheduled time and the other pipelines will be
executed 30 minutes early. If you’re comfortable with this margin of
error then it’s no big deal, but if not then an orchestrator frequency
of <code>30 minutes</code> will ensure all pipelines run as scheduled
exactly.</p>
<p>Let’s see another example:</p>
</div>
<div class="section level3">
<h3 id="example-2">Example 2<a class="anchor" aria-label="anchor" href="#example-2"></a>
</h3>
<pre><code><span><span class="co">##    name frequency          start_time</span></span>
<span><span class="co">## 1 pipe4    1 hour 2024-06-18 00:00:00</span></span>
<span><span class="co">## 2 pipe5    1 hour 2024-06-18 00:10:00</span></span>
<span><span class="co">## 3 pipe6    1 hour 2024-06-18 00:20:00</span></span></code></pre>
<p>All three pipelines are hourly but they start on different 10-minute
intervals. If we run the orchestrator at <code>1 hour</code> they’ll all
execute at the same time. If it is important that the execute at
different times, we should set it to <code>10 minutes</code>.</p>
<p>So a good heuristic is to run it as often as the smallest interval of
time difference between any pipeline. This is pretty good so long as we
don’t run it so often that the pipelines can’t complete before the next
execution time. We don’t recommend running the orchestrator more
frequently than every 5 minutes unless you’re confident that your
pipelines are fast to execute.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Make sure you consider the amount of time it takes to
execute &lt;code&gt;&lt;a href="../reference/build_schedule.html"&gt;build_schedule()&lt;/a&gt;&lt;/code&gt; and that you account for the
additional work done in &lt;code&gt;&lt;a href="../reference/run_schedule.html"&gt;run_schedule()&lt;/a&gt;&lt;/code&gt; not related to your
actual pipeline logic.&lt;/p&gt;'><sup>1</sup></a></p>
<p>Maestro has a function for providing a reasonable estimate for the
ideal orchestrator frequency called
<code><a href="../reference/suggest_orch_frequency.html">suggest_orch_frequency()</a></code>. It uses the heuristic of the most
frequent interval halved (e.g., if your highest frequency pipeline is 1
hour, it suggests 30 minutes) to a minimum 15 minutes or your most
frequent interval if it’s less. This is a bit more conservative but
protects against running things too often. If timeliness and high
frequency are really important to you, maestro might not be your best
choice.</p>
</div>
</div>
<div class="section level2">
<h2 id="final-remarks">Final Remarks<a class="anchor" aria-label="anchor" href="#final-remarks"></a>
</h2>
<p>When it comes time to deploy your project make sure that whatever you
use to actually run your project (e.g., cron, TaskScheduler, Google
Cloud Scheduler, etc.) is indeed running it at the same frequency as you
have in the orchestrator. It’s best to stick to using whole units of
time rather than fractional units - if my orchestrator runs every 15
minutes I like to have it run on the 00:00, 15:00, 30:00, and 45:00
minutes. It makes reasoning about the scheduling simpler.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Will Hipson, Ryan Garnett.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
